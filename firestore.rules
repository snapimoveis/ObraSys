rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user belongs to the requested company (Multi-tenant core)
    function isCompanyMember(companyId) {
      return isSignedIn() && request.auth.token.companyId == companyId;
    }

    // Role checks
    function hasRole(roles) {
      return request.auth.token.role in roles;
    }

    // Check if document is immutable (e.g., APPROVED status)
    function isMutableResource() {
      return !('status' in resource.data) || (resource.data.status != 'APPROVED' && resource.data.status != 'CLOSED' && resource.data.status != 'SUBMITTED');
    }

    // Audit fields enforcement
    function hasAuditFields() {
      return request.resource.data.keys().hasAll(['createdAt', 'createdBy', 'companyId']);
    }

    // --- COLLECTION RULES ---

    // 1. Companies
    match /companies/{companyId} {
      allow read: if isCompanyMember(companyId);
      allow write: if isCompanyMember(companyId) && hasRole(['admin']);
    }

    // 2. Budgets
    match /budgets/{budgetId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow create: if isCompanyMember(request.resource.data.companyId) && request.resource.data.status == 'DRAFT' && hasAuditFields();
      allow update: if isCompanyMember(resource.data.companyId) && isMutableResource() && request.resource.data.status != 'APPROVED';
      allow delete: if false;
    }

    // 3. Works
    match /works/{workId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow update: if isCompanyMember(resource.data.companyId) && hasRole(['admin', 'gestor', 'engenheiro']);
    }

    // 4. Schedules & Tasks
    match /schedules/{scheduleId} {
      allow read, write: if isCompanyMember(resource.data.companyId);
    }

    // 5. Measurements
    match /measurements/{measurementId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow create: if isCompanyMember(request.resource.data.companyId);
      allow update: if isCompanyMember(resource.data.companyId) && isMutableResource() && request.resource.data.status != 'APPROVED';
    }

    // 6. Real Costs
    match /realCosts/{costId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow create: if isCompanyMember(request.resource.data.companyId);
      allow update, delete: if false; 
    }

    // 7. RDO
    match /rdoEntries/{rdoId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow create: if isCompanyMember(request.resource.data.companyId);
      allow update: if isCompanyMember(resource.data.companyId) && isMutableResource();
    }

    // 8. Approvals
    match /approvals/{approvalId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow write: if false;
    }

    // 9. Compliance
    match /complianceItems/{itemId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow write: if isCompanyMember(resource.data.companyId) && hasRole(['admin', 'gestor', 'engenheiro']);
    }

    // 10. Audit Logs
    match /auditLogs/{logId} {
      allow read: if isCompanyMember(resource.data.companyId) && hasRole(['admin', 'gestor']);
      allow write: if false; // System only
    }
    
    // 11. Users
    match /users/{userId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow write: if false;
    }

    // --- NEW: SUPPORT TICKETS ---

    match /tickets/{ticketId} {
      // Read: Any member of the company
      allow read: if isCompanyMember(resource.data.companyId);
      
      // Create: Any member, must set correct companyId, status must be OPEN
      allow create: if isCompanyMember(request.resource.data.companyId)
                    && request.resource.data.status == 'OPEN'
                    && !request.resource.data.keys().hasAny(['readableId', 'closedAt', 'lastResponseAt']);

      // Update:
      // 1. Regular users can only update 'status' to 'RESOLVED' (close own ticket) or add messages (handled in subcollection)
      // 2. Admins/Support can update priority, status, category
      // 3. Prevent changing immutable fields (id, companyId, readableId, createdAt)
      allow update: if isCompanyMember(resource.data.companyId)
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.readableId == resource.data.readableId
                    && request.resource.data.createdAt == resource.data.createdAt;
    }

    match /tickets/{ticketId}/messages/{messageId} {
      allow read: if isCompanyMember(get(/databases/$(database)/documents/tickets/$(ticketId)).data.companyId);
      
      allow create: if isCompanyMember(get(/databases/$(database)/documents/tickets/$(ticketId)).data.companyId)
                    && request.resource.data.senderId == request.auth.uid;
                    
      allow update, delete: if false; // Messages are immutable history
    }
  }
}