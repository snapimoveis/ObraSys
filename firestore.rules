rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user belongs to the requested company (Multi-tenant core)
    function isCompanyMember(companyId) {
      return isSignedIn() && request.auth.token.companyId == companyId;
    }

    // Role checks
    function hasRole(roles) {
      return request.auth.token.role in roles;
    }

    // Check if document is immutable (e.g., APPROVED status)
    function isMutableResource() {
      return !('status' in resource.data) || (resource.data.status != 'APPROVED' && resource.data.status != 'CLOSED' && resource.data.status != 'SUBMITTED');
    }

    // Audit fields enforcement
    function hasAuditFields() {
      return request.resource.data.keys().hasAll(['createdAt', 'createdBy', 'companyId']);
    }

    // --- COLLECTION RULES ---

    // 1. Companies (Read own, Write Admin only)
    match /companies/{companyId} {
      allow read: if isCompanyMember(companyId);
      allow write: if isCompanyMember(companyId) && hasRole(['admin']);
    }

    // 2. Budgets (Critical Logic)
    match /budgets/{budgetId} {
      allow read: if isCompanyMember(resource.data.companyId);
      
      // Create: Draft only
      allow create: if isCompanyMember(request.resource.data.companyId) 
                    && request.resource.data.status == 'DRAFT'
                    && hasAuditFields();
      
      // Update: Only if DRAFT or REVIEW. Cannot set to APPROVED directly (must use Function).
      allow update: if isCompanyMember(resource.data.companyId)
                    && isMutableResource()
                    && request.resource.data.status != 'APPROVED'; // Block direct approval
      
      // Delete: Never allowed physically for audit purposes
      allow delete: if false;
    }

    // 3. Works (Created via Automation mostly, editable by Managers)
    match /works/{workId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow update: if isCompanyMember(resource.data.companyId) 
                    && hasRole(['admin', 'gestor', 'engenheiro']);
    }

    // 4. Schedules & Tasks
    match /schedules/{scheduleId} {
      allow read, write: if isCompanyMember(resource.data.companyId);
    }

    // 5. Measurements (Autos)
    match /measurements/{measurementId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow create: if isCompanyMember(request.resource.data.companyId);
      allow update: if isCompanyMember(resource.data.companyId) 
                    && isMutableResource() // Cannot edit if APPROVED
                    && request.resource.data.status != 'APPROVED'; // Approval via Function
    }

    // 6. Real Costs
    match /realCosts/{costId} {
      allow read: if isCompanyMember(resource.data.companyId);
      // Immutable once created to ensure financial integrity
      allow create: if isCompanyMember(request.resource.data.companyId);
      allow update, delete: if false; 
    }

    // 7. RDO (Site Log)
    match /rdoEntries/{rdoId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow create: if isCompanyMember(request.resource.data.companyId);
      allow update: if isCompanyMember(resource.data.companyId)
                    && isMutableResource(); // Block update if SUBMITTED
    }

    // 8. Approvals (Read Only for frontend, Write via Backend)
    match /approvals/{approvalId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow write: if false; // Only Cloud Functions manage approvals
    }

    // 9. Compliance
    match /complianceItems/{itemId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow write: if isCompanyMember(resource.data.companyId) && hasRole(['admin', 'gestor', 'engenheiro']);
    }

    // 10. Audit Logs (Strictly Read Only, Write via Backend)
    match /auditLogs/{logId} {
      allow read: if isCompanyMember(resource.data.companyId) && hasRole(['admin', 'gestor']);
      allow write: if false;
    }
    
    // 11. Users (Managed by Admin)
    match /users/{userId} {
      allow read: if isCompanyMember(resource.data.companyId);
      allow write: if false; // Managed via Admin SDK / Functions
    }
  }
}